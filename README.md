# Zeal 8-bit C Compiler

A C99 compiler targeting the Zeal 8-bit OS platform, powered by a Z80 CPU.

## Project Status

This is an iterative development project. Currently implemented:

- ‚úÖ Phase 1: Basic compiler structure
- ‚úÖ Phase 2: Lexer/Tokenizer (complete with C99 token support)
- ‚úÖ Phase 3: Parser (expressions, variables, assignments, function calls)
- ‚úÖ Phase 4: Symbol table (basic implementation)
- ‚úÖ Phase 5: Z80 code generator (expressions, statements, runtime helpers)
- ‚úÖ Phase 6: Control flow (if, while, for)
- üöß Phase 7: Stack-based locals and full calling convention
- ‚è≥ Phase 8: Optimizations and documentation

### Working Features ‚úÖ
- Complete C99 lexer with all token types
- Recursive descent parser with operator precedence
- Streaming file input on both host and ZOS (512-byte buffered reader; no full-file loads)
- Control flow: if/else, while, and for
- Comparison operators (==, !=, <, >, <=, >=)
- Binary arithmetic operators (+, -, *, /, %)
- Function definitions and calls
- Stack-based argument passing (IX frame for params)
- Stack-based local variables
- Variable declarations and assignments
- Global variable declarations
- Return statements with expressions
- Compound statements (blocks)
- Runtime library for mul/div/mod
- Expression evaluation with correct precedence
- Multiple functions per file
- `char` type and character literals

### In Progress üöß
- Target build uses 12 KB static pool; file buffer at 0xE000 (512 B)

### Planned Features ‚è≥
- Switch statement, break/continue, do/while, ternary
- Unary operators
- String literal support in codegen
- Pointers and arrays
- Struct and union types
- More operators (logical, bitwise)
- Type checking and semantic analysis
- Optimizations (constant folding, dead code elimination)
- Preprocessor support

## Building

### Desktop Build (for testing)

```bash
make
```

This will compile the compiler for your desktop (macOS/Linux) using GCC.

### ZOS Build (target platform)

```bash
zde cmake
```

Verbose build (defines `VERBOSE` for `#ifdef VERBOSE`):
```bash
zde cmake --target verbose
```

This requires:
- SDCC 4.4.0
- ZOS_PATH environment variable set to Zeal 8-bit OS source
- ZVB SDK and coreutils

## Usage

### Desktop version:
```bash
./bin/cc input.c output.asm
```

### ZOS version:
```bash
cc input.c output.asm
```

The compiler generates Z80 assembly compatible with Zealasm.

## Examples

### Simple Return Value
**Input (simple_return.c):**
```c
int main() {
    return 42;
}
```

**Generated Assembly:**
```asm
; Generated by Zeal 8-bit C Compiler
; Target: Z80

    org 0x4000

; Program code
main:
    ld a, 42
    ret
```

### Expression with Operator Precedence
**Input (expr.c):**
```c
int main() {
    return 2 + 3 * 4;  /* Correctly evaluates to 14 */
}
```

**Generated Assembly:**
```asm
main:
    ld a, 2
    push af
    ld a, 3
    push af
    ld a, 4
    ld l, a
    pop af
; Multiplication (A * L)
    call __mul_a_l
    ld l, a
    pop af
    add a, l
    ret
```

### Multiple Functions
**Input (locals_params.c):**
```c
int add(int a, int b) {
    return a + b;
}

int main() {
    int x;
    int y;
    x = 5;
    y = 10;
    return add(x, y);
}
```

**Generated Assembly:**
```asm
add:
    push ix
    ld ix, 0
    add ix, sp
    ld a, (ix+4)
    push af
    ld a, (ix+6)
    ld l, a
    pop af
    add a, l
    pop ix
    ret

main:
    ld a, 5
    ld (x), a
    ld a, 10
    ld (y), a
    call add
    ret
```

## Testing

**Important**: All test input and output files must remain in the `tests/` directory. Never write test output to `/tmp` or any location outside the project.

Run individual tests:
```bash
./bin/cc tests/simple_return.c tests/simple_return.asm      # Simple return
./bin/cc tests/expr.c tests/expr.asm  # Expression precedence
./bin/cc tests/assign.c tests/assign.asm  # Assignment chaining
./bin/cc tests/compares.c tests/compares.asm  # Comparisons
./bin/cc tests/math.c tests/math.asm  # Math ops
./bin/cc tests/if.c tests/if.asm      # If statement
./bin/cc tests/while.c tests/while.asm  # While loop
./bin/cc tests/for.c tests/for.asm    # For loop
./bin/cc tests/locals_params.c tests/locals_params.asm          # Locals + params
./bin/cc tests/params.c tests/params.asm  # Functions with parameters
./bin/cc tests/comp.c tests/comp.asm  # Factorial comprehensive
./bin/cc tests/do_while.c tests/do_while.asm  # Do/while (expected fail)
./bin/cc tests/unary.c tests/unary.asm  # Unary ops (expected fail)
./bin/cc tests/string.c tests/string.asm  # String literals (expected fail)
./bin/cc tests/char.c tests/char.asm    # Char literals
./bin/cc tests/global.c tests/global.asm  # Global variables
```

All test artifacts (`.asm`, `.o`, `.bin`, etc.) are stored in `tests/` for version control and review.

**Note**: When adding a new test source in `tests/`, also update `test.zs` so the Zeal headless script runs the new case on target hardware. Expected failures are tracked in `test.py`.

## Architecture

- `src/main.c` - Entry point and file I/O
- `src/lexer.c` - Lexical analysis (tokenization)
- `src/parser.c` - Syntax analysis (AST generation)
- `src/symbol.c` - Symbol table and type system
- `src/codegen.c` - Z80 assembly code generation

## Current Limitations

- Parser is simplified and needs expansion (no pointers/arrays/structs)
- Fixed 12 KB static pool allocator; no dynamic malloc on target
- 512-byte input reader buffer; very large source files are not supported
- No optimization passes yet
- Limited error reporting
- `long` (32-bit) is currently unsupported
- Not yet supported in codegen: do/while, unary ops, string literals, ternary operator, arrays, pointers, structs
- Not yet supported in codegen: ternary operator (?:)

## Next Steps

We will iterate on this implementation, adding:
1. Stack-based locals and calling convention for parameters
2. Semantic analysis and type checking
3. Comprehensive code generation (pointers, arrays, structs)
4. Register allocation
5. Optimization passes
6. Extended C99 feature support (switch, logical/bitwise ops, ternary)

## License

See LICENSE file for details.
