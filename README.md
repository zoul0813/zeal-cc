# Zeal 8-bit C Compiler

A C99 compiler targeting the Zeal 8-bit OS platform, powered by a Z80 CPU.

## Project Status

This is an iterative development project. Currently implemented:

- ‚úÖ Phase 1: Basic compiler structure
- ‚úÖ Phase 2: Lexer/Tokenizer (complete with C99 token support)
- ‚úÖ Phase 3: Parser (expressions, variables, assignments, function calls)
- ‚úÖ Phase 4: Symbol table (basic implementation)
- ‚úÖ Phase 5: Z80 code generator (expressions, statements, runtime helpers)
- ‚úÖ Phase 6: Control flow (if, while, for)
- üöß Phase 7: Stack-based variables and calling convention
- ‚è≥ Phase 8: Optimizations and documentation

### Working Features ‚úÖ
- Complete C99 lexer with all token types
- Recursive descent parser with operator precedence
- Streaming file input on both host and ZOS (512-byte buffered reader)
- Control flow: if/else, while, and for
- Comparison operators (==, !=, <, >, <=, >=)
- Binary arithmetic operators (+, -, *, /, %)
- Function definitions and calls
- Variable declarations and assignments
- Return statements with expressions
- Compound statements (blocks)
- Runtime library for mul/div/mod
- Expression evaluation with correct precedence
- Multiple functions per file

### In Progress üöß
- Stack-based local variables (currently emit as global labels)
- Function parameters parsed but no proper calling convention
- Argument passing for function calls

### Planned Features ‚è≥
- Switch statement, break/continue, ternary
- Pointers and arrays
- Struct and union types
- More operators (comparison, logical, bitwise)
- Type checking and semantic analysis
- Optimizations (constant folding, dead code elimination)
- Preprocessor support

## Building

### Desktop Build (for testing)

```bash
make
```

This will compile the compiler for your desktop (macOS/Linux) using GCC.

### ZOS Build (target platform)

```bash
mkdir -p build && cd build
cmake ..
make
```

This requires:
- SDCC 4.4.0
- ZOS_PATH environment variable set to Zeal 8-bit OS source
- ZVB SDK and coreutils

## Usage

### Desktop version:
```bash
./bin/cc input.c output.asm
```

### ZOS version:
```bash
cc input.c output.asm
```

The compiler generates Z80 assembly compatible with Zealasm.

## Examples

### Simple Return Value
**Input (test1.c):**
```c
int main() {
    return 42;
}
```

**Generated Assembly:**
```asm
; Generated by Zeal 8-bit C Compiler
; Target: Z80

    org 0x4000

; Program code
main:
    ld a, 42
    ret
```

### Expression with Operator Precedence
**Input (test_expr.c):**
```c
int main() {
    return 2 + 3 * 4;  /* Correctly evaluates to 14 */
}
```

**Generated Assembly:**
```asm
main:
    ld a, 2
    push af
    ld a, 3
    push af
    ld a, 4
    ld l, a
    pop af
; Multiplication (A * L)
    call __mul_a_l
    ld l, a
    pop af
    add a, l
    ret
```

### Multiple Functions
**Input (test2.c):**
```c
int add(int a, int b) {
    return a + b;
}

int main() {
    int x;
    int y;
    x = 5;
    y = 10;
    return add(x, y);
}
```

**Generated Assembly:**
```asm
add:
    ld a, (a)
    push af
    ld a, (b)
    ld l, a
    pop af
    add a, l
    ret

main:
    ld a, 5
    ld (x), a
    ld a, 10
    ld (y), a
    call add
    ret
```

## Testing

**Important**: All test input and output files must remain in the `tests/` directory. Never write test output to `/tmp` or any location outside the project.

Run individual tests:
```bash
./bin/cc tests/test1.c tests/test1.asm      # Simple return
./bin/cc tests/test_expr.c tests/test_expr.asm  # Expression precedence
./bin/cc tests/test_add.c tests/test_add.asm    # Addition
./bin/cc tests/test_mul.c tests/test_mul.asm    # Multiplication
./bin/cc tests/test2.c tests/test2.asm          # Multiple functions
./bin/cc tests/test_params.c tests/test_params.asm  # Functions with parameters
```

All test artifacts (`.asm`, `.o`, `.bin`, etc.) are stored in `tests/` for version control and review.

## Architecture

- `src/main.c` - Entry point and file I/O
- `src/lexer.c` - Lexical analysis (tokenization)
- `src/parser.c` - Syntax analysis (AST generation)
- `src/symbol.c` - Symbol table and type system
- `src/codegen.c` - Z80 assembly code generation

## Current Limitations

- Parser is simplified and needs expansion (no pointers/arrays/structs)
- Only basic code generation is implemented; locals/params are treated as globals
- Calling convention and stack-based locals not implemented yet
- Fixed 12 KB static pool allocator; no dynamic malloc on target
- 512-byte input reader buffer; very large source files are not supported
- No optimization passes yet
- Limited error reporting

## Next Steps

We will iterate on this implementation, adding:
1. Stack-based locals and calling convention for parameters
2. Semantic analysis and type checking
3. Comprehensive code generation (pointers, arrays, structs)
4. Register allocation
5. Optimization passes
6. Extended C99 feature support (switch, logical/bitwise ops, ternary)

## License

See LICENSE file for details.
